@startuml
title E-Rezept abschliessen oder zurueckweisen

actor "Mitarbeiter Apotheke" as MA
participant "AVS" as AVS
participant "Identity Provider" as IDP
participant "E-Rezept Fachdienst" as FD

MA -> AVS: Abschluss oder Rueckgabe anstossen()
activate AVS

opt kein gueltiger AuthN-Token
  ref over AVS, IDP: AuthN-Token anfordern
end

alt Task schliessen
  AVS -> FD: POST /Task/{id}/$close (AuthN-Token, Quittung)
  activate FD
  FD -> FD: Quittung pruefen()
  FD -> FD: Task abschliessen()
  FD --> AVS: Status
  deactivate FD
else Task zurueckweisen
  AVS -> FD: POST /Task/{id}/$reject (AuthN-Token)
  activate FD
  FD -> FD: Task auf ready setzen()
  FD --> AVS: Status
  deactivate FD
end

AVS --> MA: Status
deactivate AVS

@enduml
