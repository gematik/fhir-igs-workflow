

- id: E_Rezept_erstellen
  anchor: e-rezept-erstellen
  link: menu-technische-umsetzung-anwendungsfaelle.html#e-rezept-erstellen
  title: "E-Rezept erstellen"
  roles: ["(Zahn-)Arzt"]
  description: |
    Ein E-Rezept wird im Primärsystem (PVS/KIS) als Verordnungsdatensatz erstellt.
    Für die Bereitstellung auf dem E-Rezept-Fachdienst wird ein Task angelegt, über den eine Rezept-ID (PrescriptionID)
    vergeben und ein AccessCode erzeugt wird.
  preconditions: |
    - Der Leistungserbringer ist gegenüber der TI authentisiert (Institutionsidentität via SMC-B über IdP/Konnektor).
    - Der Verordnungsdatensatz liegt lokal als KBV-konformes FHIR-Bundle vor.
  actions: |
    - Das Primärsystem legt im E-Rezept-Fachdienst einen Task an.
    - Der E-Rezept-Fachdienst vergibt eine Rezept-ID (PrescriptionID) und generiert einen AccessCode.
    - Das Primärsystem übernimmt die Rezept-ID in den lokalen Verordnungsdatensatz.
  postconditions: |
    - Task liegt im Status `draft` vor.
    - Rezept-ID und AccessCode sind im Primärsystem verfügbar.
  interface: |
    - [Operation API: E-Rezept erstellen](./op-create.html)
     
- id: E_Rezept_qualifiziert_signieren
  anchor: e-rezept-qualifiziert-signieren
  link: menu-technische-umsetzung-anwendungsfaelle.html#e-rezept-qualifiziert-signieren
  title: "E-Rezept qualifiziert signieren"
  roles: ["(Zahn-)Arzt"]
  description: |
    Der Verordnungsdatensatz wird durch den (Zahn-)Arzt mittels HBA qualifiziert elektronisch signiert (QES).
    Vorbereitende Tätigkeiten im Primärsystem können organisatorisch delegiert werden, die QES selbst jedoch nicht.
  preconditions: |
    - Rezept-ID (PrescriptionID) ist im Verordnungsdatensatz enthalten.
    - Ein freigeschalteter HBA steht zur Verfügung.
    - Konsistenz: `authoredOn` im Verordnungsdatensatz entspricht dem Datum der QES.
  actions: |
    - Das Primärsystem startet die QES-Erstellung über den Konnektor.
    - Der (Zahn-)Arzt signiert den Verordnungsdatensatz mit dem HBA.
    - Das Primärsystem erhält den QES-signierten Datensatz zur weiteren Verarbeitung.
  postconditions: |
    - QES-signierter Verordnungsdatensatz liegt im Primärsystem vor.
  interface: |
    - Keine (QES im Primaersystem)

- id: E_Rezept_vervollstaendigen_und_Task_aktivieren
  anchor: e-rezept-vervollstaendigen-und-task-aktivieren
  link: menu-technische-umsetzung-anwendungsfaelle.html#e-rezept-vervollstaendigen-und-task-aktivieren
  title: "E-Rezept vervollständigen und Task aktivieren"
  roles: ["(Zahn-)Arzt"]
  description: |
    Der (Zahn-)Arzt finalisiert eine bereits erstellte Verordnung und stellt sie qualifiziert signiert für den Versicherten bereit.
    Mit der Bereitstellung startet der Einlöse-Workflow: Die Verordnung wird im E-Rezept-Fachdienst geprüft und anschließend so veröffentlicht,
    dass sie im vorgesehenen Prozess (z. B. Einlösung in der Apotheke oder Bearbeitung durch den Kostenträger) genutzt werden kann.
  preconditions: |
    - Das E-Rezept wurde zuvor erstellt und befindet sich noch in der Vorbereitungsphase.
    - Der qualifiziert signierte Verordnungsdatensatz (QES) liegt im Primärsystem vor.
    - Ein Berechtigungsmerkmal zur geschützten Bereitstellung liegt vor (z. B. AccessCode).
  actions: |
    - Das Primärsystem stellt den qualifiziert signierten Verordnungsdatensatz beim E-Rezept-Fachdienst bereit.
    - Der E-Rezept-Fachdienst prüft Berechtigung, Signatur und fachliche Konsistenz der Verordnung.
    - Bei erfolgreicher Prüfung wird die Verordnung für die weitere Verarbeitung (Einlösung/Bearbeitung) freigeschaltet.
  postconditions: |
    - Das E-Rezept ist bereitgestellt und kann im weiteren Prozess eingelöst bzw. bearbeitet werden.
    - Der Status des Workflows entspricht der bereitgestellten Verordnung.
  interface: |
    - [Operation API: E-Rezept aktivieren](./op-activate.html)
  followup: |
    - [Mapping von Verordnungsdaten](./mapping-prescription.html)
    - [Übertragung von Verordnungsdaten an den ePA MedicationService](./menu-technische-umsetzung-anbindung-epa-ms.html)

- id: E_Rezept_loeschen
  anchor: e-rezept-loeschen
  link: menu-technische-umsetzung-anwendungsfaelle.html#e-rezept-loeschen
  title: "E-Rezept löschen"
  roles: ["(Zahn-)Arzt", "Versicherter"]
  description: |
    Ein E-Rezept kann durch den verordnenden Leistungserbringer widerrufen/gelöscht werden,
    um den Patienten vor dem Bezug und der Einnahme eines fälschlich verordneten Medikaments zu schützen.
  preconditions: |
    - AccessCode ist dem Primärsystem bekannt.
    - Das E-Rezept befindet sich nicht bereits in Belieferung (ansonsten ist das Löschen nicht zulässig).
  actions: |
    - Das Primärsystem fordert das Löschen/Widerrufen des E-Rezepts beim E-Rezept-Fachdienst an.
    - Der E-Rezept-Fachdienst prüft die Berechtigung und löscht den referenzierten Task.
  postconditions: |
    - Der referenzierte Task ist gelöscht; es werden keine Nutzdaten zurückgegeben.
  interface: |
    - [Operation API: E-Rezept loeschen](./op-abort.html)

- id: E_Rezept_abrufen_apotheke
  anchor: e-rezept-abrufen-apotheke
  link: menu-technische-umsetzung-anwendungsfaelle.html#e-rezept-abrufen-apotheke
  title: "E-Rezept abrufen (Apotheke)"
  roles: ["Apotheke"]
  description: |
    Nach Übergabe von Task-ID und AccessCode durch den Versicherten ruft das Apothekenverwaltungssystem (AVS)
    das E-Rezept mittels FHIR-Operation $accept ab. Der E-Rezept-Fachdienst liefert den Task, das
    QES-signierte Verordnungsbundle und ein Secret zurück, das die Apotheke für weitere Schritte benötigt.
  preconditions: |
    - Task-ID und AccessCode wurden durch den Versicherten bereitgestellt (z. B. 2D-Code, CardLink, Nachricht).
    - Das AVS ist gegenüber der TI authentisiert und verfügt über ein gültiges Access Token.
    - Der referenzierte Task befindet sich in einem abrufbaren Status (ready) und ist noch keiner anderen Apotheke zugeordnet.
  actions: |
    - Das AVS sendet einen POST-Request auf /Task/{id}/$accept mit dem AccessCode.
    - Der Fachdienst validiert Berechtigung und liefert Task, Binary (PKCS#7) und das Secret.
    - Das AVS speichert Task, Secret, Binary und löst optional die lokale QES-Prüfung an.
  postconditions: |
    - Das Secret ist bekannt und belegt die Apotheke als aktuelle Bearbeiterin.
    - Task-Status wechselt auf `in-progress`; Verordnungsdaten liegen im AVS vor.
    - Falls Flowtype 200/209 mit Consent, liegt zusätzlich ein Consent-Resource vor.
  interface: |
    - [Operation API: Task akzeptieren](./op-accept.html)

- id: E_Rezept_secret_wiederherstellen
  anchor: e-rezept-secret-wiederherstellen
  link: menu-technische-umsetzung-anwendungsfaelle.html#e-rezept-secret-wiederherstellen
  title: "E-Rezept erneut abrufen"
  roles: ["Apotheke"]
  description: |
    Geht das beim ersten Abruf erhaltene Secret verloren, kann die gleiche Apotheke das E-Rezept
    nochmals abrufen, um das Secret und den Verordnungsdatensatz erneut zu erhalten.
  preconditions: |
    - Die Apotheke hat das E-Rezept zuvor erfolgreich abgerufen; der Task ist der Apotheke zugeordnet.
    - Task-ID und AccessCode liegen weiterhin vor.
    - Gleiches AVS / gleiche Telematik-ID wie beim Erstabruf (sonst HTTP 412 Precondition Failed).
  actions: |
    - Das AVS ruft /Task/{id}?ac=... mit HTTP GET auf.
    - Der Fachdienst stellt Task, Binary und Secret erneut bereit.
    - Das AVS ersetzt das verlorene Secret und setzt die Bearbeitung fort.
  postconditions: |
    - Secret und Verordnungsdaten stehen wieder zur Verfügung.
    - Task-Status verbleibt bei `in-progress` und bleibt der Apotheke zugeordnet.
  interface: |
    - [Query API: Task](./query-api-task.html)

- id: E_Rezept_abgabe_dokumentieren
  anchor: e-rezept-abgabe-dokumentieren
  link: menu-technische-umsetzung-anwendungsfaelle.html#e-rezept-abgabe-dokumentieren
  title: "E-Rezept-Abgabe zeitnah dokumentieren"
  roles: ["Apotheke"]
  description: |
    Vor Abschluss des Workflows kann die Apotheke über $dispense Dispensierinformationen einstellen,
    damit Versicherte und FdV zeitnah über die erfolgte Abgabe informiert werden, ohne eine Quittung auszulösen.
  preconditions: |
    - Die Apotheke besitzt das Secret aus dem vorherigen Abruf.
    - Das Rezept wurde beliefert, aber der Workflow ist noch nicht abgeschlossen.
    - Dispensierdaten (MedicationDispense + Medication) liegen im AVS vor und bleiben unterhalb der Größenlimits.
  actions: |
    - Das AVS ruft /Task/{id}/$dispense?secret=... via POST auf und übermittelt die Abgabeinformationen in einer Parameters-Ressource.
    - Der Fachdienst plausibilisiert die Daten und speichert sie ohne Statuswechsel des Tasks.
  postconditions: |
    - Dispensierinformationen stehen dem Versicherten im E-Rezept-FdV zur Verfügung.
    - Task behält Status `in-progress`; keine Quittung wurde erzeugt.
  interface: |
    - [Operation API: Dispensierinformationen bereitstellen](./op-dispense.html)

- id: E_Rezept_abgabe_abschliessen
  anchor: e-rezept-abgabe-abschliessen
  link: menu-technische-umsetzung-anwendungsfaelle.html#e-rezept-abgabe-abschliessen
  title: "E-Rezept-Abgabe vollziehen"
  roles: ["Apotheke"]
  description: |
    Nach erfolgter Belieferung schließt die Apotheke den Workflow mit $close ab, übermittelt die finalen
    Dispensierinformationen (oder verweist auf zuvor gesendete Daten) und erhält ein serverseitig signiertes Quittungs-Bundle.
  preconditions: |
    - Secret liegt vor und die Apotheke ist weiterhin berechtigt.
    - Vollständige Dispensierinformationen stehen bereit (entweder frisch oder über vorheriges $dispense).
    - Bei Flowtype 200 muss sichergestellt sein, dass dem Versicherten eine Quittung für private Abrechnung ausgehändigt wird.
  actions: |
    - Das AVS ruft /Task/{id}/$close?secret=... via POST auf und sendet die Dispensierinformationen (falls noch nicht vorhanden).
    - Der Fachdienst validiert die Daten, erstellt das Quittungs-Bundle und setzt den Task auf `completed`.
  postconditions: |
    - Der Workflow ist abgeschlossen; Quittung liegt im AVS vor und kann an Rechenzentrum/Kostenträger weitergegeben werden.
    - Versicherte sehen den Abschluss im FdV; ggf. erfolgt eine Übermittlung an BfArM bzw. ePA gemäß Flowtype.
  interface: |
    - [Operation API: Task schliessen](./op-close.html)

- id: UC_2_1_E_Rezepte_erzeugen
  anchor: uc-2-1-e-rezepte-erzeugen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-2-1-e-rezepte-erzeugen
  title: "UC 2.1 - E-Rezepte erzeugen"
  roles: ["(Zahn-)Arzt"]
  description: |
    Der verordnende Leistungserbringer erzeugt ein oder mehrere E-Rezepte im Primaersystem.
    Fuer jedes E-Rezept wird eine Rezept-ID aus dem E-Rezept-Fachdienst bezogen und der Datensatz
    anschliessend qualifiziert elektronisch signiert (QES).
  preconditions: |
    - Der oder die Versicherten sind der LEI bekannt.
    - Ein oder mehrere Verordnungsdatensaetze liegen im Primaersystem vor.
    - HBA ist gesteckt und fuer die QES freigeschaltet.
  actions: |
    - Der Leistungserbringer waehlt Verordnungsdatensaetze und ein Signaturverfahren aus.
    - Das Primaersystem ruft pro E-Rezept eine Rezept-ID beim E-Rezept-Fachdienst ab und ergaenzt sie im Datensatz.
    - Die E-Rezepte werden ueber den Konnektor mit QES signiert (Einzel-, Stapel- oder Komfortsignatur).
    - AccessCodes werden im Primaersystem gespeichert.
  postconditions: |
    - E-Rezepte enthalten Rezept-ID und QES.
    - AccessCode je E-Rezept ist im Primaersystem gespeichert.
    - E-Rezepte sind im E-Rezept-Fachdienst im Status "initialisiert" angelegt.
  interface: |
    - [Operation API: E-Rezept erstellen](./op-create.html)
    - QES im Primaersystem (Konnektor)

- id: UC_2_3_E_Rezept_einstellen
  anchor: uc-2-3-e-rezept-einstellen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-2-3-e-rezept-einstellen
  title: "UC 2.3 - E-Rezept einstellen"
  roles: ["(Zahn-)Arzt"]
  description: |
    Ein E-Rezept wird vom Primaersystem beim E-Rezept-Fachdienst eingestellt und ein E-Rezept-Token erzeugt.
  preconditions: |
    - UC 2.1 wurde ausgefuehrt; E-Rezept und Signatur liegen im Primaersystem vor.
    - Rezept-ID und AccessCode sind bekannt.
    - Status im E-Rezept-Fachdienst ist "initialisiert".
  actions: |
    - Der Leistungserbringer waehlt ein E-Rezept zum Einstellen aus.
    - Das Primaersystem aktualisiert das E-Rezept im E-Rezept-Fachdienst.
    - Das Primaersystem erstellt einen E-Rezept-Token und speichert ihn.
  postconditions: |
    - E-Rezept ist im E-Rezept-Fachdienst gespeichert und hat Status "offen".
    - Das Einstellen ist im E-Rezept-Fachdienst protokolliert.
  interface: |
    - [Operation API: E-Rezept aktivieren](./op-activate.html)

- id: UC_2_5_E_Rezept_durch_Verordnenden_loeschen
  anchor: uc-2-5-e-rezept-durch-verordnenden-loeschen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-2-5-e-rezept-durch-verordnenden-loeschen
  title: "UC 2.5 - E-Rezept durch Verordnenden loeschen"
  roles: ["(Zahn-)Arzt"]
  description: |
    Ein E-Rezept wird durch die verordnende LEI geloescht und der Status im E-Rezept-Fachdienst auf "geloescht" gesetzt.
  preconditions: |
    - UC 2.3 wurde ausgefuehrt.
    - Rezept-ID und AccessCode sind bekannt.
    - Status im E-Rezept-Fachdienst ist "offen".
  actions: |
    - Ein Mitarbeiter der verordnenden LEI markiert das E-Rezept zum Loeschen und bestaetigt den Vorgang.
    - Das Primaersystem ruft den E-Rezept-Fachdienst mit Rezept-ID und AccessCode auf.
    - Der Status wird auf "geloescht" gesetzt und medizinische Daten werden geloescht.
    - Der AccessCode wird im Primaersystem geloescht.
  postconditions: |
    - Status ist "geloescht"; personenbezogene und medizinische Daten sind entfernt.
    - Statuswechsel ist protokolliert.
  interface: |
    - [Operation API: E-Rezept loeschen](./op-abort.html)

- id: UC_3_1_E_Rezepte_durch_Versicherten_abrufen
  anchor: uc-3-1-e-rezepte-durch-versicherten-abrufen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-3-1-e-rezepte-durch-versicherten-abrufen
  title: "UC 3.1 - E-Rezepte durch Versicherten abrufen"
  roles: ["Versicherter"]
  description: |
    Ein Versicherter ruft im FdV alle seine im E-Rezept-Fachdienst eingestellten E-Rezepte ab.
  preconditions: |
    - Keine.
  actions: |
    - Das FdV fordert E-Rezepte beim E-Rezept-Fachdienst an.
    - Der E-Rezept-Fachdienst identifiziert E-Rezepte ueber die Versicherten-ID.
    - Der E-Rezept-Fachdienst liefert E-Rezepte, Status und Statuszeitpunkte; AccessCodes nur bei Abruf ueber FdV.
  postconditions: |
    - E-Rezepte stehen im FdV zur Anzeige bereit; Daten fuer E-Rezept-Token sind verfuegbar.
    - Der Abruf ist protokolliert.
  interface: |
    - [Query API: Task](./query-api-task.html)

- id: UC_3_2_E_Rezept_durch_Versicherten_loeschen
  anchor: uc-3-2-e-rezept-durch-versicherten-loeschen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-3-2-e-rezept-durch-versicherten-loeschen
  title: "UC 3.2 - E-Rezept durch Versicherten loeschen"
  roles: ["Versicherter"]
  description: |
    Der Versicherte setzt den Status eines E-Rezepts auf "geloescht" und loescht es im E-Rezept-Fachdienst.
  preconditions: |
    - UC 3.1 wurde ausgefuehrt.
    - Status des E-Rezepts ist ungleich "in Abgabe (gesperrt)".
  actions: |
    - Versicherter waehlt ein E-Rezept im FdV und bestaetigt das Loeschen.
    - Das FdV uebertraegt die Loeschanforderung an den E-Rezept-Fachdienst.
    - Der Status wird geaendert; Daten im E-Rezept werden geloescht.
    - Der E-Rezept-Token wird im FdV geloescht.
  postconditions: |
    - Status ist "geloescht"; personenbezogene und medizinische Daten sind entfernt.
    - Statuswechsel ist protokolliert.
  interface: |
    - [Operation API: E-Rezept loeschen](./op-abort.html)

- id: UC_3_3_Nachricht_durch_Versicherten_uebermitteln
  anchor: uc-3-3-nachricht-durch-versicherten-uebermitteln
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-3-3-nachricht-durch-versicherten-uebermitteln
  title: "UC 3.3 - Nachricht durch Versicherten uebermitteln"
  roles: ["Versicherter", "Vertreter"]
  description: |
    Ein Versicherter oder Vertreter uebermittelt einen E-Rezept-Token und/oder eine Nachricht an eine Apotheke
    oder einen Vertreter, wahlweise ueber die TI oder als 2D-Code.
  preconditions: |
    - UC 3.1 wurde ausgefuehrt und ein E-Rezept-Token erstellt.
    - Alternativ liegt ein E-Rezept-Token beim Vertreter vor.
  actions: |
    - Auswahl eines E-Rezept-Tokens und Versandart (TI oder 2D-Code).
    - Bei Versand ueber TI: Apotheke im Verzeichnisdienst waehlen oder KVNR2 eingeben.
    - Das FdV stellt die Nachricht mit Token und/oder Text im E-Rezept-Fachdienst ein.
    - Bei 2D-Code: Token wird als 2D-Code angezeigt oder ausgedruckt.
  postconditions: |
    - Nachricht liegt im E-Rezept-Fachdienst und kann vom Empfaenger abgerufen werden.
    - Bei 2D-Code ist der Token fuer den Empfaenger verfuegbar.
  interface: |
    - FHIR REST: Communication (E-Rezept-Nachricht einstellen)

- id: UC_3_4_Nachrichten_durch_Versicherten_empfangen
  anchor: uc-3-4-nachrichten-durch-versicherten-empfangen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-3-4-nachrichten-durch-versicherten-empfangen
  title: "UC 3.4 - Nachrichten durch Versicherten empfangen"
  roles: ["Versicherter", "Vertreter"]
  description: |
    Ein Versicherter oder Vertreter empfaengt Nachrichten von abgebenden LEI ueber den E-Rezept-Fachdienst.
  preconditions: |
    - UC 4.7 wurde ausgefuehrt.
    - UC 3.3 wurde ausgefuehrt.
  actions: |
    - Das FdV fragt beim E-Rezept-Fachdienst nach neuen Nachrichten.
    - Nachrichten werden heruntergeladen.
  postconditions: |
    - Nachrichten liegen im FdV zur Anzeige bereit.
  interface: |
    - FHIR REST: Communication (E-Rezept-Nachrichten abrufen)

- id: UC_3_8_Nachricht_durch_Versicherten_loeschen
  anchor: uc-3-8-nachricht-durch-versicherten-loeschen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-3-8-nachricht-durch-versicherten-loeschen
  title: "UC 3.8 - Nachricht durch Versicherten loeschen"
  roles: ["Versicherter"]
  description: |
    Der Versicherte loescht von ihm uebermittelte Nachrichten an Apotheken oder Versicherte.
  preconditions: |
    - UC 3.3 wurde ausgefuehrt.
  actions: |
    - Der Versicherte waehlt Nachrichten zum Loeschen aus und bestaetigt den Vorgang.
    - Das FdV uebertraegt die Loeschanforderung je Nachricht an den E-Rezept-Fachdienst.
    - Der E-Rezept-Fachdienst loescht die Nachrichten und liefert ggf. eine Warnung, wenn bereits abgerufen.
    - Die Nachrichten werden im FdV geloescht.
  postconditions: |
    - Nachrichten sind im E-Rezept-Fachdienst und im FdV geloescht.
  interface: |
    - FHIR REST: Communication (E-Rezept-Nachricht loeschen)

- id: UC_4_6_Nachrichten_durch_Abgebenden_empfangen
  anchor: uc-4-6-nachrichten-durch-abgebenden-empfangen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-4-6-nachrichten-durch-abgebenden-empfangen
  title: "UC 4.6 - Nachrichten durch Abgebenden empfangen"
  roles: ["Apotheke"]
  description: |
    Eine abgebende LEI empfaengt E-Rezept-Token ueber die TI oder optisch als 2D-Code.
  preconditions: |
    - UC 3.3 wurde ausgefuehrt oder der 2D-Code wurde praesentiert.
  actions: |
    - Das PS waehlt den Empfangsweg (TI oder 2D-Code).
    - Bei TI: PS fragt beim E-Rezept-Fachdienst neue Nachrichten fuer die Telematik-ID ab und laedt sie herunter.
    - Bei 2D-Code: PS wandelt den Code in die Token-Textform um.
  postconditions: |
    - E-Rezept-Token liegt im PS der abgebenden LEI vor.
  interface: |
    - FHIR REST: Communication (E-Rezept-Nachrichten abrufen)

- id: UC_4_7_Nachricht_durch_Abgebenden_uebermitteln
  anchor: uc-4-7-nachricht-durch-abgebenden-uebermitteln
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-4-7-nachricht-durch-abgebenden-uebermitteln
  title: "UC 4.7 - Nachricht durch Abgebenden uebermitteln"
  roles: ["Apotheke"]
  description: |
    Die abgebende LEI antwortet auf eine Nachricht eines Versicherten oder Vertreters.
  preconditions: |
    - UC 3.3 wurde ausgefuehrt.
    - UC 4.6 wurde ausgefuehrt.
  actions: |
    - Ein Mitarbeiter waehlt die Nachricht zu einem E-Rezept und erstellt eine Antwort.
    - Das PS stellt die Antwortnachricht im E-Rezept-Fachdienst ein.
  postconditions: |
    - Nachricht liegt im E-Rezept-Fachdienst und kann asynchron empfangen werden.
  interface: |
    - FHIR REST: Communication (E-Rezept-Nachricht einstellen)

- id: UC_4_9_Nachricht_durch_Abgebenden_loeschen
  anchor: uc-4-9-nachricht-durch-abgebenden-loeschen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-4-9-nachricht-durch-abgebenden-loeschen
  title: "UC 4.9 - Nachricht durch Abgebenden loeschen"
  roles: ["Apotheke"]
  description: |
    Der Abgebende loescht von ihm uebermittelte Nachrichten an Versicherte.
  preconditions: |
    - UC 4.7 wurde ausgefuehrt.
  actions: |
    - Der Abgebende waehlt Nachrichten zum Loeschen aus und bestaetigt.
    - Das PS uebertraegt Loeschanforderungen an den E-Rezept-Fachdienst.
    - Der E-Rezept-Fachdienst loescht Nachrichten und liefert ggf. Warnung bei bereits erfolgtem Abruf.
    - Nachrichten werden im PS geloescht.
  postconditions: |
    - Nachrichten sind im E-Rezept-Fachdienst und im PS geloescht.
  interface: |
    - FHIR REST: Communication (E-Rezept-Nachricht loeschen)

- id: UC_4_1_E_Rezept_durch_Abgebenden_abrufen
  anchor: uc-4-1-e-rezept-durch-abgebenden-abrufen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-4-1-e-rezept-durch-abgebenden-abrufen
  title: "UC 4.1 - E-Rezept durch Abgebenden abrufen"
  roles: ["Apotheke"]
  description: |
    Eine abgebende LEI ruft ein E-Rezept auf Basis eines E-Rezept-Tokens aus dem E-Rezept-Fachdienst ab.
  preconditions: |
    - Ein E-Rezept-Token wurde uebermittelt.
    - UC 4.6 wurde ausgefuehrt.
    - Token liegt im PS vor; Status des E-Rezepts ist "offen".
  actions: |
    - PS ermittelt Rezept-ID und AccessCode aus dem Token.
    - PS ruft das E-Rezept beim E-Rezept-Fachdienst ab.
    - Status wechselt auf "in Abgabe (gesperrt)".
    - E-Rezept-Fachdienst erzeugt ein Geheimnis zur Statusaenderung und uebermittelt es.
    - PS prueft die QES ueber den Konnektor.
  postconditions: |
    - Status ist "in Abgabe (gesperrt)" und protokolliert.
    - E-Rezept liegt im AVS vor; Geheimnis ist gespeichert.
  interface: |
    - [Operation API: Task akzeptieren](./op-accept.html)

- id: UC_4_2_E_Rezept_durch_Abgebenden_zurueckgeben
  anchor: uc-4-2-e-rezept-durch-abgebenden-zurueckgeben
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-4-2-e-rezept-durch-abgebenden-zurueckgeben
  title: "UC 4.2 - E-Rezept durch Abgebenden zurueckgeben"
  roles: ["Apotheke"]
  description: |
    Ein abgerufenes E-Rezept wird an den E-Rezept-Fachdienst zurueckgegeben.
  preconditions: |
    - UC 4.1 wurde ausgefuehrt.
    - Rezept-ID, AccessCode und Geheimnis sind bekannt.
    - Status ist "in Abgabe (gesperrt)".
  actions: |
    - Abgebender markiert das E-Rezept zum Zurueckgeben und bestaetigt.
    - PS ruft den E-Rezept-Fachdienst mit Rezept-ID, AccessCode und Geheimnis auf.
    - Status wird auf "offen" geaendert.
  postconditions: |
    - Status ist "offen" und protokolliert.
    - E-Rezept, Token und Geheimnis sind im PS geloescht.
  interface: |
    - [Operation API: Task zurueckweisen](./op-reject.html)

- id: UC_4_3_E_Rezept_durch_Abgebenden_loeschen
  anchor: uc-4-3-e-rezept-durch-abgebenden-loeschen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-4-3-e-rezept-durch-abgebenden-loeschen
  title: "UC 4.3 - E-Rezept durch Abgebenden loeschen"
  roles: ["Apotheke"]
  description: |
    Der abgebende Leistungserbringer loescht ein zuvor abgerufenes E-Rezept.
  preconditions: |
    - Ein E-Rezept-Token wurde uebermittelt und der Wunsch zum Loeschen liegt vor.
    - UC 4.6 und UC 4.1 wurden ausgefuehrt.
    - Rezept-ID, AccessCode und Geheimnis sind bekannt; Status ist "in Abgabe (gesperrt)".
  actions: |
    - Abgebender markiert das E-Rezept zum Loeschen und bestaetigt.
    - PS ruft den E-Rezept-Fachdienst mit Rezept-ID, AccessCode und Geheimnis auf.
    - Status wechselt auf "geloescht"; Daten werden entfernt.
  postconditions: |
    - Status ist "geloescht" und protokolliert; Daten sind entfernt.
    - E-Rezept, Token und Geheimnis sind im PS geloescht.
  interface: |
    - [Operation API: E-Rezept loeschen](./op-abort.html)

- id: UC_4_4_Quittung_abrufen
  anchor: uc-4-4-quittung-abrufen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-4-4-quittung-abrufen
  title: "UC 4.4 - Quittung abrufen"
  roles: ["Apotheke"]
  description: |
    Nach der Abgabe wird das E-Rezept quittiert und eine Quittung vom E-Rezept-Fachdienst abgerufen.
  preconditions: |
    - UC 4.1 wurde ausgefuehrt.
    - QES des E-Rezepts ist gueltig geprueft.
    - Rezept-ID, AccessCode und Geheimnis sind bekannt; Status ist "in Abgabe (gesperrt)".
  actions: |
    - Abgebender markiert das E-Rezept als abgegeben.
    - PS uebermittelt Rezept-ID, AccessCode, Geheimnis und Abgabeinformationen an den E-Rezept-Fachdienst.
    - Status wechselt zu "quittiert"; Quittung wird erstellt und zurueckgegeben.
  postconditions: |
    - Status ist "quittiert"; Abgabeinformationen sind gespeichert.
    - Statuswechsel ist protokolliert; Quittung liegt im PS vor.
  interface: |
    - [Operation API: Task schliessen](./op-close.html)

- id: UC_4_5_Abgabedatensatz_signieren
  anchor: uc-4-5-abgabedatensatz-signieren
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-4-5-abgabedatensatz-signieren
  title: "UC 4.5 - Abgabedatensatz durch Abgebenden signieren"
  roles: ["Apotheke"]
  description: |
    Der Abgebende signiert den Abgabedatensatz fortgeschritten oder qualifiziert (QES).
  preconditions: |
    - E-Rezept wurde dispensiert.
    - Abgabedatensatz liegt im PS bereit.
    - HBA oder SMC-B ist gesteckt und freigeschaltet.
  actions: |
    - Bei Abgabe ohne Aenderung: fortgeschrittene Signatur.
    - Bei Abgabe mit Aenderung: QES fuer den Dispensierdatensatz.
  postconditions: |
    - Abgabedatensatz ist durch den Abgebenden signiert.
  interface: |
    - Keine (Signatur im Primaersystem)

- id: UC_4_8_Quittung_erneut_abrufen
  anchor: uc-4-8-quittung-erneut-abrufen
  link: menu-technische-umsetzung-anwendungsfaelle.html#uc-4-8-quittung-erneut-abrufen
  title: "UC 4.8 - Quittung erneut abrufen"
  roles: ["Apotheke"]
  description: |
    Die Quittung wird erneut abgerufen, falls die Uebertragung beim ersten Abruf fehlgeschlagen ist.
  preconditions: |
    - UC 4.4 wurde ausgefuehrt; im PS liegt keine Quittung vor.
    - Status des E-Rezepts ist "quittiert".
  actions: |
    - Abgebender waehlt das E-Rezept und ruft die Quittung erneut ab.
    - PS uebermittelt Rezept-ID und Geheimnis; der E-Rezept-Fachdienst liefert die Quittung erneut aus.
  postconditions: |
    - Quittung liegt im PS vor.
  interface: |
    - [Operation API: Task schliessen](./op-close.html)
